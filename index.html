<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中英文校对工作台 (Material Design 3)</title>
    <!-- Google Fonts: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- MATERIAL DESIGN 3 (M3) THEME AND STYLES --- */
        :root {
            /* M3 Color Tokens are now set dynamically by JavaScript */

            /* M3 Typography Tokens */
            --md-sys-font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Noto Sans", sans-serif;
            --md-sys-typescale-body-large-font-size: 16px;
            --md-sys-typescale-body-large-line-height: 24px;
            --md-sys-typescale-body-medium-font-size: 14px;
            --md-sys-typescale-body-medium-line-height: 20px;
            --md-sys-typescale-label-large-font-size: 14px;
            --md-sys-typescale-label-large-font-weight: 500;
            --md-sys-typescale-label-medium-font-size: 12px;
            --md-sys-typescale-label-medium-line-height: 16px;
            --md-sys-typescale-title-medium-font-size: 16px;
            --md-sys-typescale-title-medium-font-weight: 500;
            --md-sys-typescale-headline-small-font-size: 24px;
            --md-sys-typescale-headline-small-line-height: 32px;
            
            /* M3 Shape & Elevation */
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 9999px;
            --md-sys-elevation-level-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-level-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-sys-elevation-level-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: var(--md-sys-font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 24px;
            box-sizing: border-box;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .workbench {
            width: 100%;
            max-width: 1600px;
            height: calc(100vh - 48px);
            max-height: 1200px;
            display: flex;
            gap: 16px;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background-color: var(--md-sys-color-surface-container-low);
            border: 1px solid var(--md-sys-color-surface-variant);
            border-radius: var(--md-sys-shape-corner-large);
            overflow: hidden;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        .pane-header {
            padding: 12px 16px;
            font-size: var(--md-sys-typescale-title-medium-font-size);
            font-weight: var(--md-sys-typescale-title-medium-font-weight);
            color: var(--md-sys-color-on-surface-variant);
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
            text-align: center;
            transition: color 0.5s ease, border-color 0.5s ease;
        }

        .editor-container {
            flex-grow: 1;
            position: relative;
            overflow-y: auto;
            padding: 16px;
        }

        .editor-content {
            font-size: var(--md-sys-typescale-body-large-font-size);
            line-height: var(--md-sys-typescale-body-large-line-height);
            color: var(--md-sys-color-on-surface);
            outline: none;
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            background: transparent;
            padding: 0;
            margin: 0;
            transition: color 0.5s ease;
        }

        #output-area[contenteditable="true"] { white-space: pre-wrap; word-wrap: break-word; }

        #output-area .added-space {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 4px;
            padding: 0.1em 0.3em;
            margin: 0 1px;
            font-size: 0.85em; /* Make the highlight slightly smaller */
            line-height: 1;
            display: inline-block;
            transition: background-color 0.5s ease, color 0.5s ease, padding 0.2s ease, margin 0.2s ease;
        }
        
        #output-area.hide-highlight .added-space {
            background-color: transparent;
            color: inherit;
            padding: 0;
            margin: 0;
            font-size: 1em;
        }

        /* 自动修正的标点/数字高亮 */
        #output-area .auto-fixed {
            background-color: var(--md-sys-color-tertiary);
            color: var(--md-sys-color-on-tertiary);
            border-radius: 4px;
            padding: 0.1em 0.2em;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        #output-area.hide-highlight .auto-fixed {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }

        /* 警告高亮（重复标点等） */
        #output-area .warning {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error-container);
            border-radius: 4px;
            padding: 0.1em 0.2em;
            text-decoration: wavy underline var(--md-sys-color-error);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        #output-area.hide-highlight .warning {
            background-color: transparent;
            color: inherit;
            padding: 0;
            text-decoration: none;
        }

        .pane-footer {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-top: 1px solid var(--md-sys-color-surface-variant);
            min-height: 48px;
            transition: border-color 0.5s ease;
        }

        .status-bar {
            font-size: var(--md-sys-typescale-label-medium-font-size);
            line-height: var(--md-sys-typescale-label-medium-line-height);
            color: var(--md-sys-color-on-surface-variant);
            user-select: none;
            transition: color 0.5s ease;
        }
        
        .footer-controls { display: flex; gap: 8px; }

        .m3-button {
            font-family: var(--md-sys-font-family);
            font-size: var(--md-sys-typescale-label-large-font-size);
            font-weight: var(--md-sys-typescale-label-large-font-weight);
            padding: 0 24px;
            height: 40px;
            border-radius: var(--md-sys-shape-corner-full);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .m3-button:hover { box-shadow: var(--md-sys-elevation-level-1); }

        .m3-button--filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .m3-button--filled.success {
            background-color: #28a745;
            color: white;
        }

        .m3-button--tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .history-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:100;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}.history-modal-overlay.visible{opacity:1;visibility:visible}
        .history-panel{width:90%;max-width:680px;max-height:80vh;background-color:var(--md-sys-color-surface-container-highest);border-radius:var(--md-sys-shape-corner-extra-large);box-shadow:var(--md-sys-elevation-level-3);display:flex;flex-direction:column;overflow:hidden;transform:scale(.95);transition:transform .3s ease, background-color 0.5s ease}
        .history-modal-overlay.visible .history-panel{transform:scale(1)}
        .history-header{padding:24px;display:flex;justify-content:space-between;align-items:center;color:var(--md-sys-color-on-surface);border-bottom:1px solid var(--md-sys-color-surface-variant); transition: color 0.5s ease, border-color 0.5s ease;}
        .history-header h2{margin:0;font-size:var(--md-sys-typescale-headline-small-font-size);line-height:var(--md-sys-typescale-headline-small-line-height)}
        .close-btn{background:0 0;border:0;color:var(--md-sys-color-on-surface-variant);font-size:2rem;cursor:pointer;line-height:1}
        
        .history-items-container{flex-grow:1;overflow-y:auto;padding:24px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;align-content:flex-start}
        .empty-history-placeholder{color:var(--md-sys-color-on-surface-variant);grid-column:1 / -1;text-align:center;margin-top:2rem}
        
        .history-item{
            padding:16px;
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level-1);
            color: var(--md-sys-color-on-surface-variant);
            font-size: var(--md-sys-typescale-body-medium-font-size);
            line-height: var(--md-sys-typescale-body-medium-line-height);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.5s ease;
        }
        .history-item:hover{
            transform: scale(1.05) rotate(0deg)!important;
            box-shadow: var(--md-sys-elevation-level-3);
            z-index: 10;
        }
        .history-content{
            white-space:pre-wrap;
            word-wrap:break-word;
            max-height:150px;
            overflow-y:auto;
            padding-bottom:8px;
            margin-bottom:8px; 
            border-bottom:1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface);
        }
        .history-date{font-size:.75rem; margin-top: auto;}
        .history-item-controls{display:flex;gap:8px; margin-top: 12px;}
        .history-action-btn{font-family:var(--md-sys-font-family);font-size:var(--md-sys-typescale-label-large-font-size);font-weight:500;background-color:transparent;border:1px solid var(--md-sys-color-outline);color:var(--md-sys-color-primary);padding:0 16px;height:32px;border-radius:var(--md-sys-shape-corner-full);cursor:pointer;transition:all .2s ease}
        .history-action-btn:hover{background-color:rgba(var(--md-sys-color-primary-rgb), 0.08);}

        @media (max-width: 900px) {
            body { padding: 0; }
            .workbench { flex-direction: column; height: 100vh; gap: 0; }
            .pane { border-radius: 0; border-left: none; border-right: none; }
            .pane:first-child { border-top: none; }
            .pane:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

    <div class="workbench">
        <div class="pane">
            <div class="pane-header">原文</div>
            <div class="editor-container">
                <textarea id="input-area" class="editor-content" placeholder="输入或粘贴您的原始文本..."></textarea>
            </div>
            <div class="pane-footer">
                 <div class="status-bar" id="input-status">0 字符 / 0 字</div>
            </div>
        </div>
        <div class="pane">
            <div class="pane-header">校对</div>
            <div class="editor-container">
                <div id="output-area" class="editor-content" contenteditable="true"></div>
            </div>
            <div class="pane-footer">
                <div class="status-bar" id="output-status">0 字符 / 0 字</div>
                <div class="footer-controls">
                    <button class="m3-button m3-button--tonal" id="toggleHighlightBtn">隐藏高亮</button>
                    <button class="m3-button m3-button--tonal" id="openHistoryBtn">历史</button>
                    <button class="m3-button m3-button--filled" id="copyButton">复制</button>
                </div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="history-modal-overlay">
        <div class="history-panel">
            <div class="history-header"><h2>历史记录</h2><button id="close-history-btn" class="close-btn">&times;</button></div>
            <div id="history-items-container" class="history-items-container"></div>
        </div>
    </div>

    <script>
        // --- M3 THEME ENGINE ---
        let currentTheme; // Will be set on load
        const themes = [
            { name: "Default Purple", vars: {'--md-sys-color-primary': '#6750A4', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#EADDFF', '--md-sys-color-on-primary-container': '#21005D', '--md-sys-color-secondary': '#625B71', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#E8DEF8', '--md-sys-color-on-secondary-container': '#1D192B', '--md-sys-color-tertiary': '#7D5260', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#FFD8E4', '--md-sys-color-on-tertiary-container': '#31111D', '--md-sys-color-error': '#B3261E', '--md-sys-color-error-container': '#F9DEDC', '--md-sys-color-on-error-container': '#410E0B', '--md-sys-color-background': '#FFFBFE', '--md-sys-color-on-background': '#1C1B1F', '--md-sys-color-surface': '#FFFBFE', '--md-sys-color-on-surface': '#1C1B1F', '--md-sys-color-surface-variant': '#E7E0EC', '--md-sys-color-on-surface-variant': '#49454F', '--md-sys-color-outline': '#79747E', '--md-sys-color-surface-container-low': '#F7F2FA', '--md-sys-color-surface-container-highest': '#E6E0E9', '--md-sys-color-primary-rgb': '103, 80, 164' } },
            { name: "Forest Green", vars: { '--md-sys-color-primary': '#386A1F', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#B7F397', '--md-sys-color-on-primary-container': '#082100', '--md-sys-color-secondary': '#55624C', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#D9E7CA', '--md-sys-color-on-secondary-container': '#131F0D', '--md-sys-color-tertiary': '#386666', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#BBEBEB', '--md-sys-color-on-tertiary-container': '#002020', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FCFDF7', '--md-sys-color-on-background': '#1A1C18', '--md-sys-color-surface': '#FCFDF7', '--md-sys-color-on-surface': '#1A1C18', '--md-sys-color-surface-variant': '#E0E4D6', '--md-sys-color-on-surface-variant': '#44483E', '--md-sys-color-outline': '#74796D', '--md-sys-color-surface-container-low': '#F6F7F1', '--md-sys-color-surface-container-highest': '#E4E5DF', '--md-sys-color-primary-rgb': '56, 106, 31' } },
            { name: "Ocean Blue", vars: { '--md-sys-color-primary': '#0061A3', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#D1E4FF', '--md-sys-color-on-primary-container': '#001D36', '--md-sys-color-secondary': '#535F70', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#D7E3F8', '--md-sys-color-on-secondary-container': '#101C2B', '--md-sys-color-tertiary': '#6B5778', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#F3DAFF', '--md-sys-color-on-tertiary-container': '#251432', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FDFCFF', '--md-sys-color-on-background': '#1A1C1E', '--md-sys-color-surface': '#FDFCFF', '--md-sys-color-on-surface': '#1A1C1E', '--md-sys-color-surface-variant': '#DFE3EB', '--md-sys-color-on-surface-variant': '#43474E', '--md-sys-color-outline': '#73777F', '--md-sys-color-surface-container-low': '#F3F4F9', '--md-sys-color-surface-container-highest': '#E2E2E6', '--md-sys-color-primary-rgb': '0, 97, 163' } },
            { name: "Sakura Pink", vars: { '--md-sys-color-primary': '#9B4055', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#FFD9DD', '--md-sys-color-on-primary-container': '#400015', '--md-sys-color-secondary': '#75565C', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#FFD9DD', '--md-sys-color-on-secondary-container': '#2B151A', '--md-sys-color-tertiary': '#775930', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#FFDEA8', '--md-sys-color-on-tertiary-container': '#2A1800', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FFFBFA', '--md-sys-color-on-background': '#201A1B', '--md-sys-color-surface': '#FFFBFA', '--md-sys-color-on-surface': '#201A1B', '--md-sys-color-surface-variant': '#F2DDE1', '--md-sys-color-on-surface-variant': '#514345', '--md-sys-color-outline': '#837375', '--md-sys-color-surface-container-low': '#F8F2F2', '--md-sys-color-surface-container-highest': '#ECE0E0', '--md-sys-color-primary-rgb': '155, 64, 85' } },
            { name: "Terra Cotta", vars: { '--md-sys-color-primary': '#8C5000', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#FFDCC2', '--md-sys-color-on-primary-container': '#2D1600', '--md-sys-color-secondary': '#725B42', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#FDDDBD', '--md-sys-color-on-secondary-container': '#2A1806', '--md-sys-color-tertiary': '#5A633A', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#DEE9B4', '--md-sys-color-on-tertiary-container': '#181E01', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FFFBFF', '--md-sys-color-on-background': '#1F1B16', '--md-sys-color-surface': '#FFFBFF', '--md-sys-color-on-surface': '#1F1B16', '--md-sys-color-surface-variant': '#F0E0D0', '--md-sys-color-on-surface-variant': '#4F4539', '--md-sys-color-outline': '#817567', '--md-sys-color-surface-container-low': '#F5F3EE', '--md-sys-color-surface-container-highest': '#EAE1D9', '--md-sys-color-primary-rgb': '140, 80, 0' } },
            { name: "Deep Indigo", vars: { '--md-sys-color-primary': '#3F5AB9', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#DDE1FF', '--md-sys-color-on-primary-container': '#001452', '--md-sys-color-secondary': '#5A5D72', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#DFE2F9', '--md-sys-color-on-secondary-container': '#171B2C', '--md-sys-color-tertiary': '#75546F', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#FFD7F6', '--md-sys-color-on-tertiary-container': '#2C122A', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FEFBFF', '--md-sys-color-on-background': '#1B1B1F', '--md-sys-color-surface': '#FEFBFF', '--md-sys-color-on-surface': '#1B1B1F', '--md-sys-color-surface-variant': '#E3E1EC', '--md-sys-color-on-surface-variant': '#46464F', '--md-sys-color-outline': '#767680', '--md-sys-color-surface-container-low': '#F3F4F9', '--md-sys-color-surface-container-highest': '#E4E2E6', '--md-sys-color-primary-rgb': '63, 90, 185' } },
            { name: "Sage Green", vars: { '--md-sys-color-primary': '#496745', '--md-sys-color-on-primary': '#FFFFFF', '--md-sys-color-primary-container': '#CBECC2', '--md-sys-color-on-primary-container': '#062107', '--md-sys-color-secondary': '#546250', '--md-sys-color-on-secondary': '#FFFFFF', '--md-sys-color-secondary-container': '#D8E7D0', '--md-sys-color-on-secondary-container': '#121F10', '--md-sys-color-tertiary': '#3A665E', '--md-sys-color-on-tertiary': '#FFFFFF', '--md-sys-color-tertiary-container': '#BDECE2', '--md-sys-color-on-tertiary-container': '#00201B', '--md-sys-color-error': '#BA1A1A', '--md-sys-color-error-container': '#FFDAD6', '--md-sys-color-on-error-container': '#410002', '--md-sys-color-background': '#FCFDF6', '--md-sys-color-on-background': '#1A1C19', '--md-sys-color-surface': '#FCFDF6', '--md-sys-color-on-surface': '#1A1C19', '--md-sys-color-surface-variant': '#E0E4DB', '--md-sys-color-on-surface-variant': '#434841', '--md-sys-color-outline': '#747971', '--md-sys-color-surface-container-low': '#F5F7F1', '--md-sys-color-surface-container-highest': '#E3E5DF', '--md-sys-color-primary-rgb': '73, 103, 69' } }
        ];

        function setTheme(theme, isInitial = false) {
            currentTheme = theme;
            const root = document.documentElement;
            Object.keys(theme.vars).forEach(key => {
                root.style.setProperty(key, theme.vars[key]);
            });
            if (!isInitial) renderHistory();
        }

        // --- APP LOGIC ---
        const inputArea=document.getElementById("input-area"),outputArea=document.getElementById("output-area"),copyButton=document.getElementById("copyButton"),toggleHighlightBtn=document.getElementById("toggleHighlightBtn"),inputStatus=document.getElementById("input-status"),outputStatus=document.getElementById("output-status"),historyModal=document.getElementById("history-modal"),openHistoryBtn=document.getElementById("openHistoryBtn"),closeHistoryBtn=document.getElementById("close-history-btn"),historyContainer=document.getElementById("history-items-container");let copyHistory=JSON.parse(localStorage.getItem("copyHistory"))||[];const escapeHTML=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        
        // --- MODIFIED WORD COUNT LOGIC ---
        const countWords=e=>{const t=e.match(/[a-zA-Z0-9]+|[\u4e00-\u9fa5]/g);return t?t.length:0};
        
        function formatAndHighlight(e){
            let t=escapeHTML(e);
            const cjk="\\u4e00-\\u9fa5";
            const alpha="a-zA-Z";
            const digit="0-9";
            // 常见单位（数字与单位之间无需增加空格）
            const units="[KkMmGgTtPp]?[Bb]|[KkMmGgTtPp][Bb]ps|fps|px|em|rem|pt|dpi|Hz|kHz|MHz|GHz|ms|[Kk]m|[Cc]m|mm|kg|[Mm]g|[Mm]b|[Gg]b|[Tt]b";
            // 全角标点符号（全角标点与其他字符之间不加空格）
            // 使用Unicode转义避免引号解析问题
            const fullWidthPunct = '\uff0c\u3002\uff01\uff1f\uff1b\uff1a\u3001\u201c\u201d\u2018\u2019\uff08\uff09\u3010\u3011\u300a\u300b\u300c\u300d\u300e\u300f\u2014\u2026\u00b7\uff5e';
            // 转义后用于正则表达式
            const fullWidthPunctEscaped = fullWidthPunct.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // === 标点符号修正 ===

            // 全角数字转半角 (１２３ → 123)
            const fullWidthDigits = '\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19';
            for(let i=0; i<10; i++){
                t=t.replace(new RegExp(fullWidthDigits[i],'g'), '<span class="auto-fixed">'+i+'</span>');
            }

            // 中文语境中半角标点转全角
            // 半角 → 全角 映射
            const punctMap = {
                ',': '\uff0c',  // , → ，
                '\\.': '\u3002', // . → 。(需要转义)
                '!': '\uff01',  // ! → ！
                '\\?': '\uff1f', // ? → ？(需要转义)
                ';': '\uff1b',  // ; → ；
                ':': '\uff1a',  // : → ：
                '\\(': '\uff08', // ( → （
                '\\)': '\uff09'  // ) → ）
            };

            // 中文后跟半角标点 → 转全角
            for(const [half, full] of Object.entries(punctMap)){
                t=t.replace(new RegExp(`([${cjk}])(${half})`, 'g'), '$1<span class="auto-fixed">'+full+'</span>');
            }
            // 半角标点后跟中文 → 转全角
            for(const [half, full] of Object.entries(punctMap)){
                t=t.replace(new RegExp(`(${half})([${cjk}])`, 'g'), '<span class="auto-fixed">'+full+'</span>$2');
            }

            // 检测重复标点符号并警告
            t=t.replace(/([！？!?]{2,})/g, '<span class="warning">$1</span>');
            t=t.replace(/([。，；：、]{2,})/g, '<span class="warning">$1</span>');

            // === 空格规则 ===
            const addSpace='$1<span class="added-space">&nbsp;</span>$2';

            // 中文 + 英文字母
            t=t.replace(new RegExp(`([${cjk}])([${alpha}])`,"g"), addSpace);
            // 英文字母 + 中文
            t=t.replace(new RegExp(`([${alpha}])([${cjk}])`,"g"), addSpace);
            // 中文 + 数字
            t=t.replace(new RegExp(`([${cjk}])([${digit}])`,"g"), addSpace);
            // 数字 + 中文（但不是数字+单位+中文的情况，单位后面的中文需要空格）
            t=t.replace(new RegExp(`([${digit}])([${cjk}])`,"g"), addSpace);

            // 移除数字与单位之间错误添加的空格
            t=t.replace(new RegExp(`([${digit}])<span class="added-space">&nbsp;<\\/span>(${units})`,"gi"),'$1$2');
            // 移除数字与百分号/度数符号之间错误添加的空格
            t=t.replace(new RegExp(`([${digit}])<span class="added-space">&nbsp;<\\/span>([%°℃℉])`,"g"),'$1$2');

            // 单位后跟中文需要加空格（如 10GB的 → 10GB 的）
            t=t.replace(new RegExp(`(${units})([${cjk}])`,"gi"),'$1<span class="added-space">&nbsp;</span>$2');
            // 百分号/度数符号后跟中文需要加空格（如 15%的 → 15% 的）
            t=t.replace(new RegExp(`([%°℃℉])([${cjk}])`,"g"),'$1<span class="added-space">&nbsp;</span>$2');

            // 移除全角标点前后错误添加的空格
            t=t.replace(new RegExp(`<span class="added-space">&nbsp;<\\/span>([${fullWidthPunctEscaped}])`,"g"),'$1');
            t=t.replace(new RegExp(`([${fullWidthPunctEscaped}])<span class="added-space">&nbsp;<\\/span>`,"g"),'$1');

            return t.replace(/\n/g,"<br>");
        }function updateStatus(e,t){const o=e.value||e.innerText;t.textContent=`${o.length} 字符 / ${countWords(o)} 字`}function handleInput(){const e=inputArea.value;outputArea.innerHTML=formatAndHighlight(e),updateStatus(inputArea,inputStatus),updateStatus(outputArea,outputStatus)}
        function addToHistory(e){
            const t=(new Date).toISOString();
            if(copyHistory.length > 0 && copyHistory[0].text === e) return;
            copyHistory.unshift({text:e,timestamp:t});
            if (copyHistory.length > 8) { copyHistory.pop(); } // Limit history to 8 items
            localStorage.setItem("copyHistory",JSON.stringify(copyHistory));
            renderHistory();
        }
        
        function renderHistory(){
            historyContainer.innerHTML="";
            if(0===copyHistory.length) return void(historyContainer.innerHTML='<p class="empty-history-placeholder">这里空空如也，试着复制一些文本吧。</p>');
            
            const noteColors = [
                currentTheme.vars['--md-sys-color-primary-container'],
                currentTheme.vars['--md-sys-color-secondary-container'],
                currentTheme.vars['--md-sys-color-tertiary-container'],
                currentTheme.vars['--md-sys-color-error-container'],
            ];

            copyHistory.forEach((t,o)=>{
                const n=document.createElement("div");
                n.className="history-item";
                const s=(Math.random()-.5)*4; // Random rotation
                n.style.backgroundColor = noteColors[o % noteColors.length];
                n.style.transform=`rotate(${s}deg)`;
                
                const a=new Date(t.timestamp),c=`${a.toLocaleDateString()} ${a.toLocaleTimeString()}`;
                n.innerHTML=`<div class="history-content">${escapeHTML(t.text)}</div><div class="history-date">${c}</div><div class="history-item-controls"><button class="history-action-btn" data-index="${o}" data-action="copy">复制</button><button class="history-action-btn" data-index="${o}" data-action="delete">删除</button></div>`;
                historyContainer.appendChild(n);
            });
        }

        function toggleHistoryModal(e){e?(renderHistory(),historyModal.style.display="flex",setTimeout(()=>{historyModal.classList.add("visible")},10)):(historyModal.classList.remove("visible"),setTimeout(()=>{historyModal.style.display="none"},300))}
        
        let isHighlightVisible = true;
        toggleHighlightBtn.addEventListener('click', () => {
            isHighlightVisible = !isHighlightVisible;
            outputArea.classList.toggle('hide-highlight');
            toggleHighlightBtn.textContent = isHighlightVisible ? '隐藏高亮' : '显示高亮';
        });

        inputArea.addEventListener("input",handleInput),outputArea.addEventListener("input",()=>updateStatus(outputArea,outputStatus)),copyButton.addEventListener("click",()=>{const e=outputArea.innerText.replace(/\u00A0/g," ");e&&navigator.clipboard.writeText(e).then(()=>{copyButton.textContent="成功!",copyButton.classList.add("success"),addToHistory(e),setTimeout(()=>{copyButton.textContent="复制",copyButton.classList.remove("success")},1500)})}),historyContainer.addEventListener("click",e=>{if(e.target.matches(".history-action-btn")){const t=e.target.dataset.index,o=e.target.dataset.action;"copy"===o?navigator.clipboard.writeText(copyHistory[t].text).then(()=>{e.target.textContent="已复制!",setTimeout(()=>{e.target.textContent="复制"},1500)}):"delete"===o&&(copyHistory.splice(t,1),localStorage.setItem("copyHistory",JSON.stringify(copyHistory)),renderHistory())}}),openHistoryBtn.addEventListener("click",()=>toggleHistoryModal(!0)),closeHistoryBtn.addEventListener("click",()=>toggleHistoryModal(!1)),historyModal.addEventListener("click",e=>{e.target===historyModal&&toggleHistoryModal(!1)});
        
        // --- INITIALIZE ---
        // Set a random theme on page load
        const initialTheme = themes[Math.floor(Math.random() * themes.length)];
        setTheme(initialTheme, true);
        
        inputArea.value = `欢迎使用中英文Smart Space校对工具！

本工具遵循《中文文案排版指北》规范，自动处理中英文混排问题。

一、空格规则：

1. 中英文之间需要增加空格
   示例：在LeanCloud上，数据存储是围绕AVObject进行的。

2. 中文与数字之间需要增加空格
   示例：今天出去买菜花了5000元。

3. 数字与单位之间无需增加空格
   示例：我家的光纤入户宽带有10Gbps，SSD一共有10TB。

4. 百分号/度数后跟中文需要空格
   示例：新MacBook Pro有15%的CPU性能提升。

5. 全角标点与其他字符之间不加空格
   示例：刚刚买了一部iPhone，好开心！

二、标点符号规则：

6. 中文语境使用全角标点（自动修正）
   错误示例：你好,世界!
   正确示例：你好，世界！

7. 英文整句内保留半角标点（不会误转换）
   正确示例：乔布斯说：「Stay hungry, stay foolish.」
   说明：引号内的英文逗号和句号保持半角

8. 数字使用半角字符（自动修正）
   错误示例：价格是１２３元
   正确示例：价格是123元

9. 不重复使用标点符号（警告提示）
   错误示例：太棒了！！！
   正确示例：太棒了！

更多示例：
- 使用GitHub登录
- 核磁共振成像（NMRI）是什么原理？
- 推荐阅读《Erta: A Comprehensive Guide》这本书。`;
        handleInput();
    </script>

</body>
</html>